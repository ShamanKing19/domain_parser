# Парсер
1. Парсер работает на node.js 16+ версии
2. Файл для запуска скрипта лежит в корне **parser.js** ```node parser.js```
3. Запуск на сервере в фоне ```npm run parser``` или ```pm2 start parser.js```
4. Мониторинг фоновых процессов ```pm2 monit```
3. Исходники парсера лежат в папке **/parser**
4. Есть тесты ```npm run test```Тесты из **guess_cms.test.js** будут постоянно падать, т. к. там набор из рандомных сайтов, которые постоянно меняются (нужны были во время разработки)
5. Можно запустить парсинг для одного домена ```node parser.js --domain=unipump.ru```
6. Можно запустить парсинг для нескольких доменом ```node parser.js --domains=unipump.ru,https://mnogomeb.ru```

# Логи 
1. Пишутся в **/parser/logs**
2. **broken_api_data** - Данные, отправленные в api, но не прошедшие валидацию, либо как-то сломавшие api (можно сразу закинуть post запрос на **/api/domain/update-many**)
3. **broken_data** - Ошибки, прилетающие от api
4. **error.txt** - Сюда пишутся логи методом ```Logger.error()``` 
5. **log.txt** - Логи парсера со статистикой: когда записан, сколько времени ушло на порцию, сколько из порции отдало статус от 200 и до 400, сколько осталось парсить 

## Таблицы с информацией о доменах
1. domains - домены и вся информация о них
> Если сайт был успешно спаршен, а при повторном парсинге отдал ошибку, то поменяется только статус (остальные данные не затрутся) 
> 
> Поле **auto_type_id** - тип сайта, определённый автоматически по ключевым словам
> 
> Поле **type_id** - тип сайта, установленный вручную. 
> Если установлен, то автоматически определять тип больше нельзя
> 
> Поле **income** - значение выручки за последний год финансовой отчётности (дубль из таблицы **company_finances**)

2. **domain_emails** - Почты, привязанные к доменам
3. **domain_phones** - Номера телефонов, привязанные к доменам
4. **website_types** - Типы доменов (заполняются из админки)
5. **website_type_keywords** - Ключевые слова, по которым должен определяться тип (ещё не реализовано)
6. **processing_statuses** - Статусы обработки домена (указываются вручную)
7. **domain_inns** - Таблица связей M:M доменов и компаний

## Таблицы с информацией о компаниях
> В рамках данного проекта **ИНН** = **Компания**
> 
> Все данные подтягиваются через api https://egrul.itsoft.ru/

1. **company_info** - Базовая информация о компании
> Поле **segment_id** - Сегмент, к которому относится компания, определяется кастомно через 
> табличку **company_finance_segments** (пока не реализовано)
> 
> Поле **post_index** - Почтовый индекс
> 
> Поле **registration_date** - Дата регистрации юр. лица
> 
> Поле **registry_date** - Дата внесения в реестр (уже не помню что за реестр)
> 
> Поле **registry_category** - Категория предприятия (1 - малое предприятие, 2 - хз, 3 - хз, ...)
> 
> Поле **last_finance_year** - Последний год финансовой отчётности (берётся из **company_finance_segments**)
> для более быстрой сортировки и фильтрации

2. **company_finances** - Финансовая отчётность компаний по годам
3. **company_finance_segments** - Сегмент, к которому относится компания по размеру выручки (пока не реализовано)
> Пример: от 30 до 50, от 50 до 100, от 100 до 150, от 150 до 200, от 200 до 300, от 300+ млн. руб. / год

